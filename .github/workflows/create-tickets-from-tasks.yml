name: Create GitHub Issues from Tasks

on:
  workflow_dispatch:
    inputs:
      spec_path:
        description: 'Path to spec tasks.md file'
        required: true
        default: 'specs/001-example/tasks.md'

jobs:
  create-issues:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Parse tasks.md and create issues
        run: |
          # Read the tasks.md file
          TASKS_FILE="${{ github.event.inputs.spec_path }}"
          
          # Extract spec name from path
          SPEC_NAME=$(echo "$TASKS_FILE" | sed 's|specs/||' | sed 's|/tasks.md||')
          
          if [ ! -f "$TASKS_FILE" ]; then
            echo "File not found: $TASKS_FILE"
            exit 1
          fi
          
          # Parse tasks and create GitHub issues
          # This is a simplified parser - in production, use a proper YAML/Markdown parser
          
          echo "Creating issues for spec: $SPEC_NAME"
          echo "Reading tasks from: $TASKS_FILE"
          
          # Output for verification
          echo "File contents:"
          head -50 "$TASKS_FILE"

      - name: Create Issue for Each Task
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const tasksFile = '${{ github.event.inputs.spec_path }}';
            const specName = tasksFile.split('/')[1];
            
            if (!fs.existsSync(tasksFile)) {
              console.log(`File not found: ${tasksFile}`);
              return;
            }
            
            const content = fs.readFileSync(tasksFile, 'utf8');
            const lines = content.split('\n');
            
            let currentPhase = '';
            const issues = [];
            
            // Parse tasks.md to extract issues
            for (const line of lines) {
              if (line.startsWith('### ')) {
                currentPhase = line.replace('### ', '').trim();
              } else if (line.startsWith('- [ ]') || line.startsWith('- [x]')) {
                const taskText = line.replace(/^- \[.\] /, '').trim();
                if (taskText) {
                  issues.push({
                    title: taskText,
                    phase: currentPhase,
                    spec: specName
                  });
                }
              }
            }
            
            console.log(`Found ${issues.length} tasks to create as issues`);
            
            // Create GitHub issues
            for (const issue of issues.slice(0, 10)) { // Limit to 10 per run to avoid rate limits
              try {
                const created = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `[${issue.spec}] ${issue.title}`,
                  body: `**Spec:** ${issue.spec}\n**Phase:** ${issue.phase}\n\nGenerated from task list.\n\nSee [tasks](${context.server_url}/${context.repo.owner}/${context.repo.repo}/blob/main/specs/${issue.spec}/tasks.md)`,
                  labels: ['spec-generated', `spec/${issue.spec}`, `phase/${issue.phase}`]
                });
                console.log(`Created issue #${created.data.number}: ${issue.title}`);
              } catch (error) {
                console.error(`Failed to create issue: ${error.message}`);
              }
            }

  report:
    runs-on: ubuntu-latest
    needs: create-issues
    if: always()
    steps:
      - name: Report Status
        run: |
          echo "âœ… Task creation workflow completed"
          echo "Check repository Issues for newly created tasks"
