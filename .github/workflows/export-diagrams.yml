name: Export Diagrams

on:
  push:
    branches: [main]
    paths:
      - 'specs/**/diagrams/**/*.mmd'
      - 'specs/**/diagrams/**/*.drawio'

  workflow_dispatch:
    inputs:
      format:
        description: 'Export format'
        required: true
        default: 'png'
        type: choice
        options:
          - png
          - svg
          - pdf

jobs:
  export-mermaid:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install mermaid-cli
        run: |
          npm install -g @mermaid-js/mermaid-cli

      - name: Convert Mermaid Diagrams
        run: |
          # Create output directory
          mkdir -p _diagrams
          
          # Find all .mmd files and convert them
          find specs -name "*.mmd" -type f | while read mmd_file; do
            # Calculate output path
            output_file="${mmd_file%.mmd}.png"
            output_dir=$(dirname "$output_file")
            
            echo "Converting: $mmd_file -> $output_file"
            
            # Convert mermaid to PNG
            mmdc -i "$mmd_file" -o "$output_file" -w 1024 -s 2
            
            # Also create SVG version
            svg_file="${mmd_file%.mmd}.svg"
            mmdc -i "$mmd_file" -o "$svg_file" -w 1024 -s 2
          done

      - name: Upload Diagram Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: exported-diagrams
          path: specs/**/diagrams/**/*.{png,svg}
          retention-days: 30

      - name: Commit Generated Diagrams
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Add generated PNG/SVG files
          git add "specs/**/diagrams/**/*.png" "specs/**/diagrams/**/*.svg"
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "No new diagrams to commit"
          else
            git commit -m "Generate diagram exports"
            git push
            echo "✅ Diagrams committed"
          fi

      - name: Generate Diagram Index
        run: |
          cat > _diagrams/index.md << 'EOF'
          # Generated Diagrams
          
          Exported diagram files from Mermaid and Draw.io sources.
          
          ## Authentication Spec
          
          - [Auth Flow](../specs/001-example/diagrams/auth-flow.svg)
          - [Data Model](../specs/001-example/diagrams/data-model.svg)
          
          ## Building
          
          Diagrams are automatically generated from `.mmd` and `.drawio` files in the specs directory.
          
          To regenerate: `npm run generate-diagrams`
          EOF
          
          cat _diagrams/index.md

      - name: Create PR with Diagrams (Optional)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v6
        with:
          script: |
            console.log('Diagram export completed');
            console.log('Generated files are available as artifacts');

  cleanup:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Diagram Export Complete ✅"
          echo "Generated PNG and SVG versions of all Mermaid diagrams"
          echo "Files committed to repository"
